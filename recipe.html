<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recipe Details</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="detail-page">
  <div class="container">
    <h1>üç¥ Recipe Details</h1>
    <div id="recipeDetails" class="recipe-details"></div>
    <button class="btn" onclick="goBack()">‚¨ÖÔ∏è Back to Search</button>
  </div>

  <script>
    const API_KEY = "089c5f803d4941859e76f1f83d561808"; 
    const recipeDetails = document.getElementById("recipeDetails");
    const recipeId = localStorage.getItem("selectedRecipeId");
    const localRecipeIndex = parseInt(localStorage.getItem("selectedLocalRecipeId")); 

    // NEW: Function to explicitly open the video URL in a new window/tab
    function openVideo(url) {
        window.open(url, '_blank');
    }
    
    // Function to process raw text into an HTML Ordered List (OL)
    function formatInstructions(rawInstructions) {
        if (!rawInstructions) {
            return "<p>Instructions not available or too complex for direct parsing. Please check the source link.</p>";
        }
        
        let cleanedInstructions = rawInstructions.replace(/<[^>]*>?/gm, '').trim();
        
        const steps = cleanedInstructions
            .split(/(\d+\.\s*)|(?<=[.?!])\s+/g) 
            .filter(segment => segment && segment.trim() !== ''); 

        let listItems = [];
        
        if (steps.length < 2) {
             listItems = cleanedInstructions
                .split(/\.\s+/)
                .map(item => item.trim())
                .filter(item => item.length > 5); 
        } else {
            listItems = steps
                .map(item => item.trim())
                .filter(item => item.length > 5 && !/^\d+\.$/.test(item))
                .map(item => item.replace(/^\d+\.\s*/, '')); 
        }
        
        if (listItems.length > 1) {
            return `<ol>${listItems.map(item => `<li>${item.endsWith('.') ? item : item + '.'}</li>`).join('')}</ol>`;
        }
        
        return `<p>${cleanedInstructions}</p>`;
    }


    async function loadRecipeDetails() {
      if (recipeId) {
        await loadFromAPI(recipeId);
      } else if (!isNaN(localRecipeIndex)) {
        await loadFromLocal(localRecipeIndex);
      } else {
        recipeDetails.innerHTML = "<p>No recipe selected.</p>";
      }
    }

    async function loadFromAPI(id) {
      recipeDetails.innerHTML = "<p class='loading-temp'>Fetching recipe details...</p>";
      
      const url = `https://api.spoonacular.com/recipes/${id}/information?includeNutrition=false&apiKey=${API_KEY}`;
      try {
        const response = await fetch(url);
        const recipe = await response.json();

        if (!recipe || recipe.status === 'failure') {
            recipeDetails.innerHTML = "<p>‚ö†Ô∏è Recipe not found in Spoonacular database or quota limit reached.</p>";
            return;
        }

        const ingredients = recipe.extendedIngredients
          .map((i) => `<li>${i.original}</li>`)
          .join("");

        const instructionsHTML = formatInstructions(recipe.instructions);
        
        const youtubeSearch = `https://www.youtube.com/results?search_query=${encodeURIComponent(
          recipe.title + " recipe"
        )}`;
        
        recipeDetails.innerHTML = `
          <div class="recipe-card">
            <img src="${recipe.image}" alt="${recipe.title}" />
            <h2>${recipe.title}</h2>
            <div class="recipe-info">
              <strong>üßÇ Ingredients:</strong>
              <ul>${ingredients}</ul>
              <strong>üë®‚Äçüç≥ Instructions:</strong>
              ${instructionsHTML} 
            </div>
            <a class="btn" href="${recipe.sourceUrl}" target="_blank">üìñ View Source</a>
            <button class="btn" onclick="openVideo('${youtubeSearch}')">üé• Watch Video</button>
          </div>
          <p class="source-label">üîπ Data Source: Spoonacular API</p>
        `;
      } catch (error) {
        recipeDetails.innerHTML = "<p>‚ö†Ô∏è Failed to load recipe details.</p>";
        console.error(error);
      }
    }

    async function loadFromLocal(index) {
      recipeDetails.innerHTML = "<p class='loading-temp'>Loading local recipe details...</p>";

      const response = await fetch("indianRecipes.json");
      const data = await response.json();
      const recipe = data[index]; 

      if (!recipe) {
        recipeDetails.innerHTML = "<p>Recipe not found in local data.</p>";
        return;
      }
      
      const instructionsHTML = formatInstructions(recipe.instructions);

      // The local JSON already has the direct YouTube link
      const youtubeLink = recipe.youtube; 
      
      const ingredients = recipe.ingredients.map((i) => `<li>${i}</li>`).join("");

      recipeDetails.innerHTML = `
        <div class="recipe-card">
          <img src="${recipe.image}" alt="${recipe.title}" />
          <h2>${recipe.title}</h2>
          <div class="recipe-info">
            <strong>üßÇ Ingredients:</strong>
            <ul>${ingredients}</ul>
            <strong>üë®‚Äçüç≥ Instructions:</strong>
            ${instructionsHTML}
          </div>
          <button class="btn" onclick="openVideo('${youtubeLink}')">üé• Watch Video</button>
        </div>
        <p class="source-label">üîπ Data Source: Local (indianRecipes.json)</p>
      `;
    }

    function goBack() {
      localStorage.removeItem("selectedRecipeId");
      localStorage.removeItem("selectedLocalRecipeId");
      window.location.href = "index.html";
    }

    loadRecipeDetails();
  </script>
</body>
</html>